最近因为想给自己的网络库增加一个数据库连接池组件，又怕自己写的too naive，所以参看了一些优秀的开源数据库连接池实现，经过一番调研，最终决定参考Libzdb来实现自己的数据库连接池。

Libzdb用C语言实现实现了一个标准的数据库连接池，代码简短精悍，具有健壮性和可扩展性。Libzdb中规中矩地封装了数据库中三个主要概念：

- Connection:数据库连接
- PreparedStatement：数据库预处理表达式
- ResultSet：数据库操作结果集

Libzdb借鉴了面向对象的思想，以上三者都是概念层面的封装，具体业务逻辑交由具体数据库相关接口实现，比如Libzdb目前支持MySQL, Sqlite,Oracle,Postgresql。而Libzdb的数据库连接池对象ConnectionPool则是Connection的组合（Connection生命周期由ConnectionPool控制）。Libzdb架构设计图的粗略表示如下：

它采用类似策略模式和桥接模式的设计，但又有些许不同，因为Connection，PreparedStatement和ResultSet的派生类型同一时刻必须一致（注意：这里为了方便采用了面向对象语言的术语来表达，但真实libzdb是用C实现，但思想是一致的，下同）。比如你想连接MySQL数据库那么Connection，PreparedStatement和ResultSet的动态类型就都是MySQL的。除了Libzdb的主要功能模块外，最让人眼前一亮的是它的异常处理模块，Libzdb用C语言实现了一套try-catch-finally机制，这部分代码有些繁琐，因为基本都是用函数宏实现的，我打开gdb -ggdb3编译选项进行编译，然后调试时把宏全部展开再结合代码才算弄清楚它的脉络。虽然这部分代码以后可能根本用不到，因为C++，Java编译器已经支持了这样的机制，但是通过看C语言的实现有助于加深try-catch机制的理解，包括所谓的“栈展开”是怎么回事，我个人的直觉是C++或者Java的编译器底层实现估计与Libzdb中的try-catch实现应该异曲同工。下面是Libzdb异常处理模块的主要代码，大家可以欣赏一下：

